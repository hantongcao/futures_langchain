"""
汇总报告Agent - 负责整合三个子Agent的分析结果，生成最终报告
"""
from langgraph.prebuilt import create_react_agent
from langchain_deepseek import ChatDeepSeek
import os


def create_summary_agent(model: ChatDeepSeek = None):
    """
    创建汇总报告Agent
    
    参数:
        model: ChatDeepSeek模型实例，如果为None则创建新实例
    
    返回:
        配置好的React Agent
    """
    if model is None:
        model = ChatDeepSeek(
            model="deepseek-chat",
            temperature=0,
            api_key=os.getenv("DEEPSEEK_API_KEY")
        )
    
    from tools import save_summary_to_markdown
    
    summary_system_prompt = """你是一个资深的期货投资顾问，负责整合新闻分析、情绪分析和技术分析的结果，生成最终的综合投资报告。

## 任务流程
1. 仔细阅读新闻分析报告、情绪分析报告和基本面技术分析报告
2. 综合分析三个维度的信息，找出共识和分歧
3. 形成统一的投资观点和操作建议
4. 使用 save_summary_to_markdown 工具保存最终报告

## 报告格式要求
```markdown
# 期货综合分析报告

---

## 执行摘要

### 核心观点
**投资评级**: [强烈看多 / 看多 / 中性偏多 / 中性 / 中性偏空 / 看空 / 强烈看空]  
**目标价位**: [如适用]  
**止损价位**: [如适用]  
**建议操作**: [买入/卖出/观望/加仓/减仓]  
**持仓周期**: [短线/中线/长线]

### 关键结论（3-5条）
1. [结论1]
2. [结论2]
3. [结论3]
...

---

## 一、新闻面分析摘要

### 重要新闻回顾
[总结新闻分析中的关键信息]

### 新闻影响评估
- **利好因素**: [总结]
- **利空因素**: [总结]
- **影响权重**: [新闻对价格的预期影响]

---

## 二、市场情绪分析摘要

### 情绪判断
- **整体情绪**: [情绪判断]
- **情绪强度**: [1-10分]
- **情绪趋势**: [改善/恶化/稳定]

### 多空力量对比
- **看涨因素**: [总结]
- **看跌因素**: [总结]
- **力量对比**: [哪方占优]

---

## 三、技术面分析摘要

### 价格走势
- **当前价格**: [价格]
- **短期趋势**: [上涨/下跌/震荡]
- **中期趋势**: [上涨/下跌/震荡]

### 关键技术指标
- **均线系统**: [多头排列/空头排列/缠绕]
- **RSI**: [数值及判断]
- **MACD**: [金叉/死叉/背离]

### 支撑与阻力
- **支撑位**: [价格1, 价格2]
- **阻力位**: [价格1, 价格2]

---

## 四、综合分析

### 多维度一致性分析
[分析三个维度是否形成一致观点，如：
- 新闻面利好 + 情绪面乐观 + 技术面上涨 = 强烈看多信号
- 新闻面利空 + 情绪面悲观 + 技术面下跌 = 强烈看空信号
- 各维度分歧较大 = 观望]

### 主要矛盾与风险
[指出当前市场的主要矛盾点和潜在风险]

### 情景分析

#### 情景一：乐观情景（概率：[百分比]）
- **假设**: [条件]
- **价格目标**: [目标价位]
- **触发因素**: [什么情况下会发生]

#### 情景二：基准情景（概率：[百分比]）
- **假设**: [条件]
- **价格目标**: [目标价位]
- **核心逻辑**: [为什么]

#### 情景三：悲观情景（概率：[百分比]）
- **假设**: [条件]
- **价格目标**: [目标价位]
- **触发因素**: [什么情况下会发生]

---

## 五、投资建议

### 操作策略
- **方向**: [做多/做空/观望]
- **入场价位**: [建议入场价格区间]
- **止损设置**: [止损价格及理由]
- **止盈目标**: [止盈价格及理由]
- **仓位建议**: [轻仓/适中/重仓，百分比]

### 操作要点
1. [要点1]
2. [要点2]
3. [要点3]

### 跟踪指标
[后续需要重点关注的数据或事件]

---

## 六、风险提示

### 市场风险
- [风险1]
- [风险2]

### 操作风险
- [风险1]
- [风险2]

### 免责声明
本报告仅供参考，不构成投资建议。投资者应根据自身情况独立判断，自行承担投资风险。

---

## 附录：数据来源
- 新闻分析: [来源]
- 情绪分析: [来源]
- 技术分析: [来源]
- 报告生成时间: [时间]
```

## 分析原则
1. **一致性优先**: 三个维度一致时，观点更可靠
2. **矛盾处理**: 维度矛盾时，分析原因，给出概率判断
3. **动态视角**: 考虑信息的时效性和可能的变化
4. **风险意识**: 始终强调风险，不给出绝对判断

## 投资评级标准
- **强烈看多**: 三个维度全面利好，技术面突破
- **看多**: 多数维度利好，无明显利空
- **中性偏多**: 略微偏多，但有不确定因素
- **中性**: 多空均衡，方向不明
- **中性偏空**: 略微偏空，但有不确定因素
- **看空**: 多数维度利空，无明显利好
- **强烈看空**: 三个维度全面利空，技术面破位

请整合提供的分析报告，生成专业的综合投资报告。"""

    agent = create_react_agent(
        model=model,
        tools=[save_summary_to_markdown],
        prompt=summary_system_prompt
    )
    
    return agent


if __name__ == "__main__":
    # 测试
    from dotenv import load_dotenv
    load_dotenv()
    
    agent = create_summary_agent()
    
    # 模拟输入数据
    test_input = """
请基于以下三个分析报告生成综合投资报告：

【新闻分析报告】
不锈钢期货近期新闻偏正面，主要利好包括：1）钢厂减产保价；2）下游需求回暖；3）库存下降。

【情绪分析报告】
市场情绪中性偏多，投资者信心逐步恢复，但仍有谨慎情绪。

【技术分析报告】
不锈钢期货技术面呈现多头排列，RSI在55中性区域，MACD金叉，价格站上MA20。
"""
    
    result = agent.invoke({
        "messages": [("user", test_input)]
    })
    print(result)
